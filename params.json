{
  "name": "☕️",
  "tagline": "PID Espresso Controller + Siri Support for the Raspberry Pi or Odroid C2",
  "body": "# espresso-arm: PID Espresso Controller + Siri\r\n\r\n## A Project for Odroid C2 / Raspberry Pi 3\r\n\r\nThis is an embedded ARM modification for home espresso machines to add:\r\n\r\n* Accurate PID temperature control\r\n* A pretty touch interface\r\n* Control over the local network via a unified GUI\r\n* Siri and HomeKit support for voice-activated heating\r\n\r\nI use an [Odroid C2](http://ameridroid.com/products/odroid-c2) for this project. A Raspberry Pi 3 will work just as well. I also show installation in a rather uncommon Lelit espresso machine. This will work fine in your Rancilio Silvia and most other single-boiler machines, but you'll need to be comfortable figuring out the wiring. If you want specific build instructions for the Silvia, send me one!\r\n\r\nThe Odroid C2 (or Raspberry Pi) hosts the control application on a local webserver. Attach a touchscreen and control your espresso machine there, or use the local web interface with any phone, tablet, or computer.\r\n\r\n![Interface](http://i.imgur.com/gbyqMFy.png)\r\n\r\nThe app logic, GPIO pin control (PWM), a PID controller, and the thermocouple driver are all implemented in Python. Even the GUI and local web server are generated with Python ([Remi](https://github.com/dddomodossola/remi)).\r\n\r\nSiri support (via [Homebridge](https://github.com/nfarina/homebridge)) requires Node.js, which causes a big dependency mess. If you don't want Siri support, everything else will work fine, and installation will be much easier for you.\r\n\r\n<!-- ![Gif](https://s3.amazonaws.com/hal.bz/static/images/espressogif.gif) -->\r\n![gif](espressogif.gif)\r\n\r\n### Parts List\r\n\r\nPrice | Supplier (US) | Name + Link\r\n----- | ------------- | ----\r\n$49 | Ameridroid | [Odroid C2 + USB to 2.5mm Power Adapter](http://ameridroid.com/products/odroid-c2)\r\n$15 | Adafruit   | [Thermocouple Amplifier](https://www.adafruit.com/products/269)\r\n$10 | Adafruit   | [Thermocouple](https://www.adafruit.com/products/270)\r\n$5  | Adafruit   | [Thermal Tape](https://www.adafruit.com/products/1468)\r\n$10 | Amazon     | [SD Card](https://smile.amazon.com/Samsung-Class-Adapter-MB-MG16EA-AM/dp/B014W1ZL3S/ref=sr_1_1?ie=UTF8&qid=1466254153&sr=8-1)\r\n$7  | Amazon     | [Solid State Relay (SSR)](https://smile.amazon.com/gp/product/B00E1LC1VK/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$5  | Amazon     | [14 AWG Wire, Marine Grade](https://smile.amazon.com/gp/product/B000NV2E6O/ref=od_aui_detailpages00?ie=UTF8&psc=1)\r\n$6  | Amazon     | [Weatherproof Connectors](https://smile.amazon.com/gp/product/B00GMO98NI/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$10 | Amazon     | [Breadboard Wires](https://smile.amazon.com/gp/product/B00M5WLZDW/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$9  | Amazon     | [USB Wifi Adapter](https://smile.amazon.com/gp/product/B003MTTJOY/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$4  | Amazon     | [USB Extension Cable](https://smile.amazon.com/Tripp-Lite-Universal-Reversible-UR024-18N-RA/dp/B00ESZJEEG/ref=sr_1_29?s=electronics&ie=UTF8&qid=1465866122&sr=1-29&keywords=usb+extension)\r\n$**130**    |            |  \r\n\r\n### Tools\r\n\r\nPrice | Supplier (US) | Name + Link\r\n----- | ------------- | ----\r\n$19 | Amazon     | [Soldering Iron](https://smile.amazon.com/gp/product/B0192PZD1Y/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$5  | Amazon     | [Solder Remover](https://smile.amazon.com/gp/product/B00L2HRW92/ref=od_aui_detailpages01?ie=UTF8&psc=1)\r\n$18 | Amazon     | [Wire Strippers](https://smile.amazon.com/gp/product/B000OQ21CA/ref=oh_aui_detailpage_o02_s00?ie=UTF8&psc=1)\r\n\r\n## Software Installation\r\n\r\nIf you're starting from scratch, I recommend Arch Linux ARM. This guide assumes you're running Arch. If you already have a Linux distribution on your Odroid/Pi, and you're comfortable with Linux, you should be able to figure out how this translates to your platform.\r\n\r\n### Installing Linux\r\n\r\nArch Linux ARM provides a great installation guide for each platform:\r\n\r\n * [Odroid C2](https://archlinuxarm.org/platforms/armv8/amlogic/odroid-c2)\r\n * [Raspberry Pi 3](https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3)\r\n\r\n Follow the guide for your platform to get up-and-running with Arch Linux. You'll need another Linux machine to flash the SD card with Arch Linux, so hopefully you already run Linux somewhere.\r\n\r\nOnce you have bootable media with Arch Linux, you'll need to set up Wifi and get everything working while you have access to a keyboard & monitor. I strongly suggest reading the Arch Linux Wiki's [general recommentations](https://wiki.archlinux.org/index.php/General_recommendations) page.\r\n\r\n### Prerequisites\r\n\r\n* `python`\r\n* `WiringPi` + `WiringPi-Python`\r\n\r\nIf you want Siri support, you'll also need:\r\n* `python2`\r\n* `avahi`\r\n* `nodejs` + `npm`\r\n* [`Homebridge`](https://github.com/nfarina/homebridge)\r\n* [`homebridge-http`](https://github.com/rudders/homebridge-http)\r\n\r\n### Installing espresso-arm\r\n\r\nAs root:\r\n\r\n    pacman -S git python python-pip base-devel\r\n\r\n* On the Odroid:\r\n\r\n        pacman -S wiringc1\r\n        git clone https://github.com/hardkernel/WiringPi2-Python.git\r\n        pip install WiringPi2-Python/\r\n\r\n* On the Raspberry Pi:\r\n\r\n        pacman -S wiringpi\r\n        git clone --recursive https://github.com/WiringPi/WiringPi-Python.git\r\n        pip install WiringPi2-Python/\r\n\r\n````\r\ncd ~\r\ngit clone https://github.com/hallee/espresso-arm.git\r\ncd espresso-arm/remi/\r\npython setup.py install\r\ncp ../espresso.service /etc/systemd/system\r\nsystemctl start espresso\r\nsystemctl enable espresso\r\n````\r\n\r\nFor automatic login to root (make sure you've changed your root password at least):\r\n\r\n    systemctl edit getty@tty1\r\n    [Service]\r\n    ExecStart=\r\n    ExecStart=-/usr/bin/agetty --autologin root --noclear %I $TERM\r\n\r\n\r\nNow espresso-arm should be installed and running on a local webserver. The systemd unit files (`espresso.service`) will run the application automatically in the event of a reboot.\r\nYou'll probably want to set up your device with a static IP.\r\n\r\nTo access the interface from another device, browse to your Odroid or Pi's IP address at port 8081. In my case this is `192.168.1.83:8081`.\r\n\r\n#### Extra Steps for Siri Support\r\n\r\nFor Siri support, as root:\r\n\r\n    pacman -S python2 nodejs npm avahi\r\n\r\n    systemctl start avahi-daemon\r\n    systemctl enable avahi-daemon\r\n\r\n    npm install -g homebridge --unsafe-perm\r\n    npm install -g homebridge-http\r\n    cp ~/espresso-arm/config.json ~/.homebridge/config.json\r\n\r\n    cp ~/espresso-arm/espresso-siri.service /etc/systemd/system\r\n    systemctl start espresso-siri\r\n    systemctl enable espresso-siri\r\n\r\nFinally, follow the ['Adding Homebridge to iOS'](https://github.com/nfarina/homebridge#adding-homebridge-to-ios) guide to get this working on your phone/watch.\r\n\r\n## Hardware Installation\r\n\r\nProceed with caution. Make sure your espresso machine is unplugged completely before opening it. Every component in your espresso machine is likely wired with live AC mains power (even the lights in my machine are wired directly to mains). This is much more dangerous than working in a computer (with low-voltage DC components) and you **will** be shocked if you touch any components while the machine is on.\r\n\r\n![1](http://i.imgur.com/vJzehOn.jpg)\r\n\r\nMy Lelit PL041QE. It's not sold anymore. The machine doesn't really matter though. Wiring should be mostly the same in similarly-priced machines like the Rancilio Silvia.\r\n\r\n![2](http://i.imgur.com/Un4NWUI.jpg)\r\n\r\nThe factory wiring for my Lelit.\r\n\r\n![3](http://i.imgur.com/oUSbbAr.jpg)\r\n\r\nThis is how the SSR should be wired. Heavy gauge wire on the AC-switching output. You can just use breadboard wires on the DC side. Daisy-chain a few male-female breadboard wires if you need a longer run.\r\n\r\n![4](http://i.imgur.com/g3kOtSm.jpg)\r\n\r\nSince my entire espresso machine is powered from mains, I needed to use a DC power supply. This splits the mains power coming into the machine; one leg goes to the USB power supply, and the other leg (blue female plugs) to the main switch of the espresso machine.\r\n\r\nNote: this USB power supply ended up causing a lot of issues with the GPIO and I was getting faulty readings from the thermocouple amplifier. I replaced it with an Apple 5V 1A brick and that solved my problems. Make sure you use a quality USB power supply here.\r\n\r\n![5](http://i.imgur.com/eyYWPdv.jpg)\r\n\r\nThere's a lot going on here:\r\n\r\n* The SSR has been mounted on the left side of the machine with the thermal tape.\r\n* I've removed the brown wires from one of the thermostats (there's three of them; the black circular things with two contacts each, coming out of the boiler) and connected them to the AC switching wires on the SSR. **Important note:** because of the thermostat I've bypassed, my main power switch *and the steam switch* must both be flipped for my software temperature control to work without tripping any other thermostats.\r\n* I've unplugged the white and black mains power cables from the main switch. I'll connect these to the USB power supply from the last image.\r\n\r\n![6](http://i.imgur.com/z6LtDr5.jpg)\r\n\r\nHere's the USB power supply installed. Now the mains power goes to both the main machine switch and the USB power supply, instead of *just* the main power switch. In this configuration, the Odroid or Raspberry Pi will always have power as long as the cord is plugged into the wall, even if the machine's main switch is off.\r\n\r\n![7](http://i.imgur.com/QS8wCSQ.jpg)\r\n\r\nI epoxied the thermocouple into a hole in the boiler. Epoxy was probably too permanent a solution to this. You can probably come up with something cleaner. But it works.\r\n\r\n![8](http://i.imgur.com/JMVEbyh.jpg)\r\n\r\nHere's the thermocouple amplifier all soldered up and ready to go.\r\n\r\n![9](http://i.imgur.com/LgUuCQH.jpg)\r\n\r\nThe Odroid C2 with all the wires connected. The pins I'm using (top-to-bottom corresponds to left-to-right in the image:)\r\n\r\nPhysical Pin Number | WiringPi Pin Number | Color | Name | Usage\r\n------------------- | ------------------- | ----- | ---- | -----\r\n1  | -  | Gray   | 3.3v     | Vin (Thermocouple Amplifier)\r\n6  | -  | Black  | 0v       | Ground (Thermocouple Amplifier)\r\n12 | 1  | Brown  | GPIO.238 | DO (Thermocouple Amplifier)\r\n16 | 4  | Red    | GPIO.236 | CS (Thermocouple Amplifier)\r\n18 | 5  | Orange | GPIO.233 | CLK (Thermocouple Amplifier)\r\n36 | 27 | White  | GPIO.218 | On/Off (SSR)\r\n39 | -  | Black  | 0v       | Ground (SSR)\r\n\r\nI'm not sure if the pins are the same on the Raspberry Pi 3. Run `gpio readall` to see your pin layout. You may have to wire your Pi differently. The thing that matters is to make sure the ground wires are connected to ground on your device, the thermocouple amplifier Vin is connected to a +3.3 or 5v source on your device, and everything else is wired to a GPIO pin. Just make sure to change all the GPIO pin numbers in software if you picked differently.\r\n\r\n![10](http://i.imgur.com/xSbcVHx.jpg)\r\n\r\nMy Odroid C2 mounted comfortably. I used electrical tape to mount it. Good enough.\r\n\r\nThe wifi was very spotty with the module connected directly to the Odroid down there, so I used a USB extender to get the wifi adapter very close to the outer sheet metal at the top.\r\n\r\n![11](http://i.imgur.com/R5xS9CZ.jpg)\r\n\r\nThat's it!\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}